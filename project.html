<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ковер</title>
    <link rel="stylesheet" href="project_styles.css">
<!customcode>
</head>

<body>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarpetGram | Главная</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
<style>
/* --- Общие Стили и Палитра --- */
:root {
    --primary-color: #6a11cb; /* Глубокий фиолетовый для градиента */
    --secondary-color: #2575fc; /* Ярко-синий для градиента */
    --accent-color: #ff5722; /* Оранжевый для акцентов (лайки) */
    --background-light: #f4f6f8; /* Светлый фон */
    --card-background: #ffffff; /* Белый фон карточек */
    --border-color: #e0e0e0;
    --gray-area: #f0f0f0; /* Серый цвет для области загрузки */
    --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
    --shadow-heavy: 0 8px 24px rgba(0, 0, 0, 0.1);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
}

body {
    background-color: var(--background-light);
    padding-bottom: 80px; /* Отступ для главного статус-бара */
    color: #333;
    overflow-x: hidden;
}

/* --- Градиентный Текст --- */
.logo-text,
.logo-icon,
.add-icon {
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    display: inline-block;
}

/* --- Верхний Заголовок (Логотип и Название) --- */
.top-header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background-color: var(--card-background);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    padding: 0 15px;
    z-index: 100;
    box-shadow: var(--shadow-light);
}

.logo-link {
    display: flex;
    align-items: center;
    text-decoration: none;
    cursor: pointer;
}

.logo-icon {
    width: 30px;
    height: 30px;
    margin-right: 8px;
    /* Иконка ковра из интернета не будет градиентной напрямую, но градиент применяется к тексту */
}

.logo-text {
    font-size: 1.5rem;
    font-weight: 700;
}

/* --- Главный Статус-Бар (Нижний, Неподвижный) --- */
.status-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 70px;
    background-color: var(--card-background);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-around;
    align-items: center;
    z-index: 100;
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
    padding: 0 10px;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: #999;
    font-size: 0.7rem;
    transition: color 0.3s;
    flex: 1;
}

.nav-item:hover, .nav-item.active {
    color: var(--primary-color);
}

.nav-icon {
    font-size: 24px;
    margin-bottom: 2px;
}

/* Кнопка ПЛЮС (Больше, Градиент) */
.add-button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    border: none;
    color: white;
    font-size: 30px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    box-shadow: var(--shadow-heavy);
    transform: translateY(-15px); /* Поднять над полосой */
    transition: transform 0.2s;
}

.add-button:active {
    transform: translateY(-13px) scale(0.98);
}

.add-icon {
    color: white !important; /* Принудительно белый для иконки на градиенте */
    -webkit-text-fill-color: white !important;
}

/* --- Лента Постов (Главная) --- */
.post-feed {
    padding: 75px 15px 15px 15px; /* Отступ сверху для хедера */
    max-width: 600px;
    margin: 0 auto;
}

.post-card {
    background-color: var(--card-background);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-heavy);
    transition: transform 0.2s, box-shadow 0.2s;
}

.post-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.post-title {
    font-size: 1.25rem;
    color: var(--primary-color);
    margin-bottom: 10px;
}

.post-image {
    width: 100%;
    height: auto;
    max-height: 400px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
    background-color: var(--gray-area); /* Серый фон, пока картинка грузится */
}

.post-text {
    font-size: 1rem;
    line-height: 1.4;
    color: #555;
    margin-bottom: 15px;
}

.no-posts, .loading-message, .no-results {
    text-align: center;
    padding: 20px;
    color: #999;
}


/* --- Действия (Лайк/Дизлайк/Коммент) --- */
.post-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);
}

.action-button {
    display: flex;
    align-items: center;
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    font-size: 0.9rem;
    transition: color 0.3s;
    padding: 5px 10px;
    border-radius: 6px;
}

.action-button span:first-child {
    font-size: 20px;
    margin-right: 5px;
}

/* Стиль для активных/залитых иконок */
.like-button.active {
    color: var(--accent-color); /* Заливка лайка оранжевым */
}
.dislike-button.active {
    color: var(--secondary-color); /* Заливка дизлайка синим */
}

/* --- Модальное Окно (Общий стиль) --- */
.modal {
    position: fixed;
    z-index: 200;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
    display: none; /* Скрыто по умолчанию JS */
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: var(--background-light);
    border-radius: 12px 12px 0 0;
    width: 100%;
    max-width: 600px;
    max-height: 90%;
    display: flex;
    flex-direction: column;
    position: absolute;
    bottom: 0;
}

.close-button {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close-button:hover,
.close-button:focus {
    color: #000;
}

/* --- Модальное Окно Комментариев --- */
.comments-content {
    padding: 20px;
}

.comments-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.comments-list {
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 10px;
    margin-bottom: 15px;
}

.comment-item {
    background-color: var(--card-background);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: var(--shadow-light);
}

.comment-author {
    font-weight: bold;
    color: var(--primary-color);
    margin-right: 5px;
}

.comment-form {
    display: flex;
    gap: 10px;
}

.comment-form input {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
}

.comment-form button {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
}

/* --- Модальное Окно Поиска --- */
.search-content {
    max-height: 100%;
    bottom: initial; /* Сбросить bottom: 0; */
    top: 0;
    border-radius: 0;
}

.search-header {
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--card-background);
}

#search-input {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 20px;
    font-size: 1rem;
    outline: none;
}

.search-results {
    padding: 15px;
    overflow-y: auto;
    max-height: calc(100vh - 70px); /* Высота модала поиска - высота хедера */
}

/* --- Страница Создания Поста --- */
.create-post-container {
    padding: 75px 15px 15px 15px;
    max-width: 600px;
    margin: 0 auto;
}

.create-post-container h1 {
    text-align: center;
    color: var(--secondary-color);
    margin-bottom: 25px;
    font-weight: 600;
}

.post-form input[type="text"],
.post-form textarea {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s;
}

.post-form input[type="text"]:focus,
.post-form textarea:focus,
#image-url:focus {
    border-color: var(--primary-color);
    outline: none;
}

.image-upload-area {
    background-color: var(--gray-area);
    border: 2px dashed #ccc;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.image-icon {
    font-size: 48px;
    color: #999;
}

.image-upload-area p {
    color: #666;
    margin-bottom: 10px;
}

#image-url {
    background-color: var(--card-background);
    border-style: solid;
    padding: 8px;
}

#publish-button {
    width: 100%;
    padding: 15px;
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.3s;
    box-shadow: var(--shadow-light);
}

#publish-button:hover:not(:disabled) {
    opacity: 0.9;
}

#publish-button:disabled {
    background: #ccc;
    cursor: not-allowed;
}
</style>
</head>
<body>

    <header class="top-header">
        <a href="index.html" class="logo-link">
            <img src="https://img.icons8.com/color/48/000000/carpet.png" alt="Логотип ковра" class="logo-icon">
            <span class="logo-text">CarpetGram</span>
        </a>
    </header>

    <main class="post-feed" id="post-feed-container">
        <div class="loading-message" id="loading-message">Загрузка постов...</div>
    </main>

    <div id="comments-modal" class="modal">
        <div class="modal-content comments-content">
            <div class="comments-header">
                <h3>Комментарии</h3>
                <span class="close-button" onclick="closeCommentsModal()">&times;</span>
            </div>
            <div id="comments-list" class="comments-list">
                </div>
            <div class="comment-form">
                <input type="text" id="new-comment-text" placeholder="Ваш комментарий...">
                <button onclick="submitComment()">Опубликовать</button>
            </div>
        </div>
    </div>

    <div id="search-modal" class="modal">
        <div class="modal-content search-content">
            <div class="search-header">
                <input type="text" id="search-input" placeholder="Поиск по заголовку или тексту поста..." oninput="filterPosts()">
                <span class="close-button" onclick="closeSearchModal()">&times;</span>
            </div>
            <div id="search-results" class="post-feed search-results">
                </div>
        </div>
    </div>

    <nav class="status-bar">
        <a href="index.html" class="nav-item">
            <span class="material-symbols-outlined nav-icon">home</span>
            <span class="nav-label">Главная</span>
        </a>

        <button class="add-button" onclick="window.location.href='post.html'">
            <span class="material-symbols-outlined add-icon">add</span>
        </button>

        <a href="#" class="nav-item" onclick="openSearchModal()">
            <span class="material-symbols-outlined nav-icon">search</span>
            <span class="nav-label">Поиск</span>
        </a>
    </nav>

    <script>
        // Инициализация Firebase (ВАЖНО: Использовать предоставленный ключ)
        const firebaseConfig = {
            apiKey: "AIzaSyCidNF4Y4KtInPicVuiHpsyM3UtnXfjHuI",
            authDomain: "baseofsos.firebaseapp.com",
            databaseURL: "https://baseofsos-default-rtdb.firebaseio.com",
            projectId: "baseofsos",
            storageBucket: "baseofsos.firebasestorage.app",
            messagingSenderId: "543658307069",
            appId: "1:543658307069:web:6089023d57da67ddeffd94",
            measurementId: "G-X39SMCSECC"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const database = app.database();
        const postsRef = database.ref('posting');

        // --- Утилиты для Local Storage (Сохранение действий пользователя) ---
        const userActions = JSON.parse(localStorage.getItem('userActions')) || {};

        function saveUserAction(postId, type) {
            if (!userActions[postId]) {
                userActions[postId] = { like: false, dislike: false };
            }
            // type: 'like' или 'dislike'
            userActions[postId][type] = !userActions[postId][type]; // Инвертируем текущее состояние
            localStorage.setItem('userActions', JSON.stringify(userActions));
        }

        function getUserAction(postId, type) {
            return userActions[postId] && userActions[postId][type];
        }

        // --- Обработчик Лайков/Дизлайков ---
        function handleLikeDislike(postId, action) {
            const isLiking = action === 'like';
            const isDisliking = action === 'dislike';

            const currentState = getUserAction(postId, action);
            const oppositeState = getUserAction(postId, isLiking ? 'dislike' : 'like');

            // 1. Обновляем Firebase
            let updates = {};

            // Если состояние меняется (на лайк/дизлайк)
            if (!currentState) {
                // Увеличиваем счетчик текущего действия
                updates[`/${action}s`] = firebase.database.ServerValue.increment(1);

                // Если было противоположное действие, отменяем его
                if (oppositeState) {
                    const oppositeAction = isLiking ? 'dislike' : 'like';
                    updates[`/${oppositeAction}s`] = firebase.database.ServerValue.increment(-1);
                    saveUserAction(postId, oppositeAction); // Обновляем LS для противоположного
                }
            }
            // Если отменяем действие (повторное нажатие)
            else {
                updates[`/${action}s`] = firebase.database.ServerValue.increment(-1);
            }

            // 2. Обновляем Local Storage
            saveUserAction(postId, action);

            // 3. Отправляем изменения в Firebase
            database.ref(`posting/${postId}`).update(updates).then(() => {
                // Перерисовка поста для обновления иконок и счетчиков
                renderPosts();
            }).catch(error => {
                console.error("Ошибка при обновлении счетчиков:", error);
            });
        }


        // --- Логика Комментариев (Модальное окно) ---
        let currentPostId = null;

        function openCommentsModal(postId) {
            currentPostId = postId;
            document.getElementById('comments-modal').style.display = 'flex';
            loadComments(postId);
        }

        function closeCommentsModal() {
            document.getElementById('comments-modal').style.display = 'none';
            currentPostId = null;
        }

        function loadComments(postId) {
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = ''; // Очистка
            database.ref(`posting/${postId}/comments`).on('value', (snapshot) => {
                commentsList.innerHTML = ''; // Повторная очистка при получении данных
                const comments = snapshot.val();
                if (comments) {
                    Object.values(comments).forEach(comment => {
                        const commentDiv = document.createElement('div');
                        commentDiv.className = 'comment-item';
                        // Здесь можно было бы добавить имя пользователя, но для простоты просто 'Аноним'
                        commentDiv.innerHTML = `
                            <span class="comment-author">Аноним:</span>
                            <span class="comment-text">${comment.text}</span>
                        `;
                        commentsList.appendChild(commentDiv);
                    });
                } else {
                    commentsList.innerHTML = '<div class="no-comments">Пока нет комментариев. Будьте первым!</div>';
                }
            });
        }

        function submitComment() {
            const textInput = document.getElementById('new-comment-text');
            const commentText = textInput.value.trim();

            if (commentText && currentPostId) {
                const newCommentRef = database.ref(`posting/${currentPostId}/comments`).push();
                newCommentRef.set({
                    text: commentText,
                    timestamp: Date.now()
                }).then(() => {
                    textInput.value = ''; // Очистка поля ввода
                    // Комментарии загрузятся автоматически благодаря `on('value', ...)`
                }).catch(error => {
                    console.error("Ошибка при добавлении комментария:", error);
                });
            }
        }

        // --- Логика Поиска (Модальное окно) ---

        let allPostsData = {}; // Хранить все посты для поиска

        function openSearchModal() {
            document.getElementById('search-modal').style.display = 'flex';
            document.getElementById('search-results').innerHTML = ''; // Очистка при открытии
            document.getElementById('search-input').value = '';
            // Повторно загружать посты не нужно, они уже в allPostsData
        }

        function closeSearchModal() {
            document.getElementById('search-modal').style.display = 'none';
        }

        function filterPosts() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';

            if (query.length === 0) {
                return;
            }

            const filteredPosts = Object.entries(allPostsData).filter(([id, post]) => {
                const titleMatch = post.title.toLowerCase().includes(query);
                const textMatch = post.text.toLowerCase().includes(query);
                return titleMatch || textMatch;
            });

            if (filteredPosts.length > 0) {
                filteredPosts.forEach(([postId, post]) => {
                    resultsContainer.appendChild(createPostElement(postId, post));
                });
            } else {
                resultsContainer.innerHTML = '<div class="no-results">По вашему запросу ничего не найдено.</div>';
            }
        }


        // --- Основная Логика Рендеринга Постов ---

        function createPostElement(postId, post) {
            const postDiv = document.createElement('div');
            postDiv.className = 'post-card';

            const isLiked = getUserAction(postId, 'like');
            const isDisliked = getUserAction(postId, 'dislike');

            const likeIconFill = isLiked ? 'fill' : 'outlined';
            const dislikeIconFill = isDisliked ? 'fill' : 'outlined';

            postDiv.innerHTML = `
                <h2 class="post-title">${post.title}</h2>
                <img src="${post.imageUrl}" alt="${post.title}" class="post-image">
                <p class="post-text">${post.text}</p>
                <div class="post-actions">
                    <button class="action-button like-button ${isLiked ? 'active' : ''}" onclick="handleLikeDislike('${postId}', 'like')">
                        <span class="material-symbols-${likeIconFill}">thumb_up</span>
                        <span>${post.likes || 0}</span>
                    </button>
                    <button class="action-button dislike-button ${isDisliked ? 'active' : ''}" onclick="handleLikeDislike('${postId}', 'dislike')">
                        <span class="material-symbols-${dislikeIconFill}">thumb_down</span>
                        <span>${post.dislikes || 0}</span>
                    </button>
                    <button class="action-button comment-button" onclick="openCommentsModal('${postId}')">
                        <span class="material-symbols-outlined">comment</span>
                        <span>Комментировать</span>
                    </button>
                </div>
            `;
            return postDiv;
        }

        function renderPosts() {
            const container = document.getElementById('post-feed-container');
            const loadingMessage = document.getElementById('loading-message');
            container.innerHTML = ''; // Очистка перед загрузкой

            // Получение данных из Firebase
            postsRef.on('value', (snapshot) => {
                container.innerHTML = '';
                loadingMessage.style.display = 'none'; // Скрыть сообщение о загрузке

                const posts = snapshot.val();

                if (posts) {
                    allPostsData = posts; // Сохраняем для поиска

                    // Отображаем посты в обратном порядке (самые новые сверху)
                    Object.keys(posts).reverse().forEach(postId => {
                        const post = posts[postId];
                        container.appendChild(createPostElement(postId, post));
                    });
                } else {
                    container.innerHTML = '<p class="no-posts">Пока нет ни одного ковра. Будьте первым!</p>';
                }
            }, (error) => {
                console.error("Ошибка Firebase:", error);
                loadingMessage.innerText = 'Ошибка загрузки данных.';
            });
        }

        // Запуск загрузки постов при старте
        document.addEventListener('DOMContentLoaded', renderPosts);

    </script>
</body>
</html></body>
</html>